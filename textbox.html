<!doctype html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="description" content="Author: Jamie Marriott">
<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1">
<link rel="stylesheet" href="css/plymouth_reset.css">
<link rel="stylesheet" href="css/plymouth_framework.css">
<title>University of Plymouth</title>
<style>
:root {
--highlight-light: #b4c960;
--highlight-dark: #a80075;
}
/*
* {
	outline: 1px dotted red;
	outline-offset: -1px;
}
*/
section {
	max-width: 60em;
	overflow: hidden;
}
section :last-child {
	margin-bottom: 0;
}
#textbox {
	width: 100%;
	min-height: 10em;
	border: 1px solid var(--mgrey);
	border-radius: 0.5em;
	padding: 0.5em;
	font-size: 1em;
	line-height: 1.5;
	outline: none;
	white-space: pre-wrap;
	box-sizing: border-box;
	margin-bottom: 1em;
}
.buttons button {
	padding: 0.5em;
	border: none;
	border-radius: 0.5em;
	background-color: var(--lgrey);
	color: var(--black);
	font-size: 0.875em;
	cursor: pointer;
	transition: background-color 0.3s ease;
	margin: 0 0.25em 0.5em 0;
	outline-offset: 2px;
}
.buttons button:hover {
	background-color: var(--mgrey);
}
.mb-0-5 {
	margin-bottom: 0.5em;
}
.save-btn-container {
	width: 100%;
	overflow: hidden;
	display: flex;
	justify-content: flex-end;
}
.save-btn-container > button {
	margin: 0;
}
</style>
</head>
<body>
<main>
  <section class="p-responsive">
    <h2>Textbox tags</h2>
    <div class="stroke p-responsive rounded-responsive">
      <div id="textbox" contenteditable="true"></div>
      <div class="save-btn-container">
        <button class="btn btn-primary">Save</button>
      </div>
      <h3 class="m-0 mb-0-5">Liquid tags</h3>
      <div class="buttons mb-1">
        <button data-key="course">Course name</button>
        <button data-key="tariff">UCAS tariff</button>
        <button data-key="ucas">UCAS course code</button>
        <button data-key="institute">Institution code</button>
        <button data-key="published">Published code</button>
        <button data-key="duration">Duration</button>
        <button data-key="mode">Mode of study</button>
        <button data-key="location">Location</button>
        <button data-key="start">Start date</button>
      </div>
      <h3 class="m-0 mb-0-5">Fees tags</h3>
      <div class="buttons mb-1">
        <button data-key="currentfee">Current fee year</button>
        <button data-key="nextfeeyear">Next fee year</button>
        <button data-key="homefeecurrent">Home fee current year fee</button>
        <button data-key="homefeenext">Home fee next year fee</button>
        <button data-key="internationalfeecurrent">International fee current year fee</button>
        <button data-key="internationalfeenext">International fee next year fee</button>
        <button data-key="parttimefeecurrent">Part time fee current year fee</button>
        <button data-key="parttimefeenext">Part time fee next year fee</button>
      </div>
      <h3 class="m-0 mb-0-5">Credit note tags</h3>
      <div class="buttons">
        <button data-key="credits">Credits</button>
        <button data-key="creditdescription">Credit description</button>
      </div>
    </div>
  </section>
</main>
<script>
const placeholders = {
    course: '{{course.name}}',
    tariff: '{{course.new_ucas_tariff}}',
    ucas: '{{course.ucas_course_code}}',
    institute: '{{course.version.institution_code}}',
    published: '{{course.published_version.institution_code}}',
    duration: '{{course.duration}}',
    mode: '{{course.study_mode}}',
    location: '{{course.location}}',
    start: '{{course.start_date_text}}',
    currentfee: '{{course.fees.current_fee_year}}',
    nextfeeyear: '{{course.fees.next_fee_year}}',
    homefeecurrent: '{{course.fees.home_fees.current_year_fees}}',
    homefeenext: '{{course.fees.home_fees.next_year_fees}}',
    internationalfeecurrent: '{{course.fees.international_fees.current_year_fees}}',
    internationalfeenext: '{{course.fees.international_fees.next_year_fees}}',
    parttimefeecurrent: '{{course.fees.part_time_home_fees.current_year_fees}}',
    parttimefeenext: '{{course.fees.part_time_home_fees.next_year_fees}}',
    credits: '{{course.fees.part_time_home_fees.credits}}',
    creditdescription: '{{course.fees.part_time_home_fees.description}}'
};

const textbox = document.getElementById('textbox');

// Utility: check if a space is needed before insertion
function needsLeadingSpace(range) {
    let node = range.startContainer;
    let offset = range.startOffset;

    if (node.nodeType === Node.TEXT_NODE) {
        if (offset > 0) {
            return node.textContent[offset - 1] !== ' ';
        } else {
            // Check previous sibling if at start of text node
            let prev = node.previousSibling;
            while (prev && prev.nodeType !== Node.TEXT_NODE) prev = prev.previousSibling;
            return !(prev && prev.textContent.slice(-1) === ' ');
        }
    } else if (node.nodeType === Node.ELEMENT_NODE) {
        if (offset > 0) {
            let prevChild = node.childNodes[offset - 1];
            if (prevChild.nodeType === Node.TEXT_NODE) {
                return prevChild.textContent.slice(-1) !== ' ';
            }
        }
    }
    return true;
}

// Insert a placeholder text at cursor
function insertText(key) {
    let textToInsert = placeholders[key];
    textbox.focus();

    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);

        if (needsLeadingSpace(range)) textToInsert = ' ' + textToInsert;
        textToInsert += ' ';

        const textNode = document.createTextNode(textToInsert);
        range.deleteContents();
        range.insertNode(textNode);

        range.setStartAfter(textNode);
        range.setEndAfter(textNode);
        sel.removeAllRanges();
        sel.addRange(range);
    } else {
        textbox.appendChild(document.createTextNode(' ' + textToInsert + ' '));
    }
}

// Paste handler with same logic
textbox.addEventListener('paste', function(e) {
    e.preventDefault();
    const pastedText = (e.clipboardData || window.clipboardData).getData('text');

    const sel = window.getSelection();
    if (sel.rangeCount > 0) {
        const range = sel.getRangeAt(0);
        let textToInsert = pastedText;

        if (needsLeadingSpace(range)) textToInsert = ' ' + textToInsert;

        const textNode = document.createTextNode(textToInsert);
        range.deleteContents();
        range.insertNode(textNode);

        range.setStartAfter(textNode);
        range.setEndAfter(textNode);
        sel.removeAllRanges();
        sel.addRange(range);
    } else {
        textbox.appendChild(document.createTextNode(' ' + pastedText));
    }
});

// Attach click event to buttons
document.querySelectorAll('.buttons button').forEach(button => {
    button.addEventListener('click', () => {
        const key = button.getAttribute('data-key');
        insertText(key);
    });
});

// Set focus to the textbox on page load
window.addEventListener('DOMContentLoaded', () => {
    textbox.focus();
});
</script>
</body>
</html>
